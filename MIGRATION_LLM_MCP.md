# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É LLM+MCP

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### ‚ùå –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ (–∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ MCP –≤—ã–∑–æ–≤—ã)
```python
async def _execute_youtrack_analysis_direct(self, context):
    # –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã MCP API
    user_result = await session.call_tool('user_current', {})
    workitems_result = await session.call_tool('workitems_list', {...})
    # –ñ–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
```

### ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (LLM —É–ø—Ä–∞–≤–ª—è–µ—Ç MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏)
```python
async def _execute_with_llm_and_mcp(self, agent, context, mcp_servers):
    # LLM –ø–æ–ª—É—á–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    allowed_tools = self.stage_config.get('allowed_tools')
    system_prompt = self._build_system_prompt_with_mcp(agent, mcp_servers)
    
    # LLM —Å–∞–º —Ä–µ—à–∞–µ—Ç –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    result = await llm_integration.execute_with_mcp_tools(..., allowed_tools=allowed_tools)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –≥–∏–±–∫–æ—Å—Ç—å** - LLM –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–ª—è workflow
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º
3. **–ê–≥–µ–Ω—Ç–Ω–æ—Å—Ç—å** - LLM –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
4. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ YAML

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è workflow

```yaml
stages:
  - name: user_activity_review
    agent: analyst
    mcp_servers:
      - youtrack-mcp
    allowed_tools:          # ‚Üê –¢–æ–ª—å–∫–æ —ç—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã LLM
      - user_current
      - workitems_list
      - issues_starred_list
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
AgentNode ‚Üí WorkflowLLMIntegration ‚Üí QwenCodeProvider
    ‚Üì              ‚Üì                      ‚Üì
allowed_tools ‚Üí Tool Filter ‚Üí MCP Servers
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

1. **Stage config** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `allowed_tools` –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
2. **WorkflowLLMIntegration** –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç MCP —Å–µ—Ä–≤–µ—Ä–æ–≤
3. **Tool Filter** –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ `allowed_tools`
4. **LLM** –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ system prompt

## –ü—Ä–∏–º–µ—Ä system prompt

```
–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ YouTrack. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- user_current: –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- workitems_list: –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ work items –∑–∞ –ø–µ—Ä–∏–æ–¥
- issues_starred_list: –ø–æ–ª—É—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

–î–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: TOOL_CALL:tool_name:parameters_json
```

## –°—Ç–∞—Ç—É—Å

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- WorkflowLLMIntegration –∫–ª–∞—Å—Å
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ `allowed_tools`
- QwenCodeProvider.generate_with_tools()
- Tool calls –ø–∞—Ä—Å–µ—Ä
- System prompt –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

‚ö†Ô∏è **TODO:**
- –†–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ MCP –≤—ã–∑–æ–≤–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
cd /home/vyt/devel/flowcraft
uv run python test_llm_mcp.py
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞!** LLM –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ workflow. üîí
