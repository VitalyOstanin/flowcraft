# План реализации FlowCraft - Мультиагентный AI CLI агент

## Содержание

1. [Обзор проекта](#1-обзор-проекта)
2. [Этап 1: Базовая инфраструктура](#2-этап-1-базовая-инфраструктура)
3. [Этап 2: Система настроек и конфигурации](#3-этап-2-система-настроек-и-конфигурации)
4. [Этап 3: Система доверия команд](#4-этап-3-система-доверия-команд)
5. [Этап 4: MCP менеджер](#5-этап-4-mcp-менеджер)
6. [Этап 5: Базовые инструменты](#6-этап-5-базовые-инструменты)
7. [Этап 6: LLM интеграция](#7-этап-6-llm-интеграция)
8. [Этап 7: Менеджер агентов](#8-этап-7-менеджер-агентов)
9. [Этап 8: Workflow система](#9-этап-8-workflow-система)
10. [Этап 9: Интерактивный CLI](#10-этап-9-интерактивный-cli)
11. [Этап 10: Система команд управления](#11-этап-10-система-команд-управления)
12. [Этап 11: Конкретные workflow](#12-этап-11-конкретные-workflow)
13. [Этап 12: Тестирование и оптимизация](#13-этап-12-тестирование-и-оптимизация)
14. [Приоритеты и зависимости](#14-приоритеты-и-зависимости)

## 1. Обзор проекта

### Цель
Создать мультиагентный AI CLI агент для выполнения различных workflow:
- Разработка нового software проекта
- Разработка новой фичи SAAS микросервисов  
- Анализ инцидентов
- Исправление багов
- Анализ и фильтрация данных

### Ключевые особенности
- Интерактивная сессия с выбором workflow
- Stateful память с сохранением между перезапусками
- Система доверия команд с гранулярным контролем
- Динамическое управление MCP серверами и агентами
- LLM Router для оптимизации затрат
- Human-in-the-loop поддержка

## 2. Этап 1: Базовая инфраструктура [ВЫПОЛНЕНО]

### Задачи
1. **Создание структуры проекта** [ВЫПОЛНЕНО]
   ```
   flowcraft/
   ├── src/
   │   ├── core/
   │   ├── workflows/
   │   ├── agents/
   │   ├── tools/
   │   ├── mcp/
   │   └── llm/
   ├── cli.py
   └── requirements.txt
   ```

2. **Настройка зависимостей** [ВЫПОЛНЕНО]
   - LangGraph для workflow управления
   - LangChain для инструментов
   - prompt_toolkit для CLI
   - rich для форматирования
   - PyYAML для конфигураций
   - Pydantic для валидации

3. **Базовый CLI интерфейс** [ВЫПОЛНЕНО]
   - Точка входа в приложение
   - Обработка аргументов командной строки
   - Инициализация основных компонентов

### Результат
- Рабочая структура проекта
- Установленные зависимости
- Базовый CLI запуск

## 3. Этап 2: Система настроек и конфигурации [ВЫПОЛНЕНО]

### Задачи
1. **Создание src/core/settings.py** [ВЫПОЛНЕНО]
   - Класс для работы с settings.yaml
   - Валидация настроек через Pydantic
   - Поддержка переменных окружения
   - Создание настроек по умолчанию

2. **Структура settings.yaml** [ВЫПОЛНЕНО]
   ```yaml
   language: ru
   llm:
     cheap_model: qwen-code
     expensive_model: kiro-cli
     expensive_stages: [security_review, architecture_design]
   mcp_servers: []
   trust_rules: {}
   workflows_dir: ~/.flowcraft/workflows
   agents: {}
   ```

3. **Создание директории конфигураций** [ВЫПОЛНЕНО]
   - ~/.flowcraft/workflows/
   - Примеры YAML конфигураций workflow

### Результат
- Система настроек с валидацией
- Файл settings.yaml.example
- Директория для workflow конфигураций

## 4. Этап 3: Система доверия команд [ВЫПОЛНЕНО]

### Задачи
1. **Создание src/core/trust.py** [ВЫПОЛНЕНО]
   - Enum TrustLevel (once, session, always, deny)
   - Класс TrustManager
   - Методы проверки и сохранения правил доверия

2. **Функциональность** [ВЫПОЛНЕНО]
   - Проверка команд по паттернам
   - Интерактивный запрос разрешений
   - Сессионные разрешения (не сохраняются)
   - Постоянные правила (сохраняются в settings.yaml)

3. **Интеграция с инструментами** [ВЫПОЛНЕНО]
   - Обертка для системных команд
   - Автоматическая проверка перед выполнением

### Результат
- Система доверия команд
- Интерактивные запросы разрешений
- Сохранение правил в настройках

## 5. Этап 4: MCP менеджер

### Задачи
1. **Создание src/mcp/manager.py**
   - Класс MCPManager
   - Управление жизненным циклом MCP серверов
   - Workflow-специфичные серверы

2. **Функциональность**
   - Запуск/остановка MCP серверов
   - Включение/отключение для workflow
   - Добавление/удаление серверов
   - Перезапуск серверов

3. **Создание src/mcp/client.py**
   - MCP клиент для взаимодействия с серверами
   - Обработка MCP протокола

### Результат
- Динамическое управление MCP серверами
- Workflow-специфичные конфигурации
- MCP клиент для взаимодействия

## 6. Этап 5: Базовые инструменты [ВЫПОЛНЕНО]

### Задачи
1. **Создание src/tools/filesystem.py** [ВЫПОЛНЕНО]
   - Чтение/запись файлов
   - Создание директорий
   - Поиск файлов через fdfind

2. **Создание src/tools/shell.py** [ВЫПОЛНЕНО]
   - Выполнение системных команд
   - Интеграция с системой доверия
   - Обработка вывода команд

3. **Создание src/tools/search.py** [ВЫПОЛНЕНО]
   - Поиск содержимого через ripgrep (rg)
   - Индексация и кэширование результатов

### Результат
- Набор базовых инструментов
- Интеграция с системой доверия
- Оптимизированный поиск

## 7. Этап 6: LLM интеграция [ВЫПОЛНЕНО]

### Задачи
1. **Создание src/llm/providers.py** [ВЫПОЛНЕНО]
   - Абстрактный класс LLM провайдера
   - Унифицированный интерфейс для разных моделей

2. **Создание src/llm/qwen.py** [ВЫПОЛНЕНО]
   - Интеграция с qwen-code API
   - Обработка запросов и ответов

3. **Создание src/llm/kiro_cli.py** [ВЫПОЛНЕНО]
   - Интеграция с kiro-cli
   - Неинтерактивный режим запуска

4. **Создание src/llm/router.py** [ВЫПОЛНЕНО]
   - LLM Router для выбора модели
   - Анализ сложности задач
   - Оптимизация затрат

### Результат
- Поддержка множественных LLM провайдеров
- Автоматический выбор модели
- Оптимизация затрат

## 8. Этап 7: Менеджер агентов [ВЫПОЛНЕНО]

### Задачи
1. **Создание src/agents/manager.py** [ВЫПОЛНЕНО]
   - Dataclass Agent
   - Enum AgentStatus
   - Класс AgentManager с CRUD операциями

2. **Функциональность** [ВЫПОЛНЕНО]
   - Создание/обновление/удаление агентов
   - Глобальное включение/отключение
   - Workflow-специфичное управление
   - Сохранение в settings.yaml

3. **Создание src/agents/roles.py** [ВЫПОЛНЕНО]
   - Определение стандартных ролей
   - Шаблоны промптов для ролей

### Результат
- Система управления агентами
- CRUD операции с агентами
- Гибкое включение/отключение

## 9. Этап 8: Workflow система [ЧАСТИЧНО ВЫПОЛНЕНО]

### Задачи
1. **Создание src/workflows/base.py** [ВЫПОЛНЕНО]
   - Базовый класс BaseWorkflow
   - Система состояний WorkflowState (упрощенная версия)
   - Базовая логика выполнения шагов

2. **Создание src/workflows/loader.py** [ВЫПОЛНЕНО]
   - Загрузка YAML конфигураций
   - Валидация workflow описаний
   - Создание экземпляров workflow

3. **Создание src/core/session.py** [НЕ ВЫПОЛНЕНО - В TODO]
   - Управление сессиями
   - LangGraph checkpointers
   - Сохранение/восстановление состояния

4. **Создание subgraphs** [НЕ ВЫПОЛНЕНО - В TODO]
   - src/workflows/subgraphs/code_review.py
   - src/workflows/subgraphs/testing.py
   - src/workflows/subgraphs/deployment.py

### Результат
- Базовая система workflow (упрощенная)
- Загрузка конфигураций из YAML
- Пример workflow для исправления багов

## 10. Этап 9: Интерактивный CLI [ВЫПОЛНЕНО]

### Задачи
1. **Создание интерактивного интерфейса** [ВЫПОЛНЕНО]
   - rich для красивого вывода
   - Простое меню навигации
   - Выбор workflow и управление агентами

2. **Функциональность** [ВЫПОЛНЕНО]
   - Выбор workflow из списка
   - Сбор деталей задачи
   - Управление агентами (создание, удаление, просмотр)
   - Отображение настроек

3. **Интеграция компонентов** [ВЫПОЛНЕНО]
   - Менеджер агентов
   - Система настроек
   - Загрузчик workflow
   - Базовые инструменты

### Результат
- Рабочий интерактивный CLI
- Интеграция всех основных компонентов
- Простой пользовательский интерфейс

## 11. Этап 10: Система команд управления

### Задачи
1. **Создание src/core/commands.py**
   - Парсер команд управления
   - Обработчики команд
   - Валидация параметров

2. **Команды MCP**
   - /mcp add/remove/restart
   - /mcp enable/disable для workflow

3. **Команды агентов**
   - /agent create/list/show/update/delete
   - /agent enable/disable глобально и для workflow

4. **Команды workflow**
   - /workflow skip-stage
   - /workflow from-stage

5. **Команды сессии**
   - /session save/resume/list

6. **LLM-инициированные команды**
   - Предложения команд от LLM
   - Подтверждение пользователем

### Результат
- Полная система команд управления
- LLM интеграция для предложений
- Динамическое управление во время выполнения

## 12. Этап 11: Конкретные workflow

### Задачи
1. **Feature Development Workflow**
   - src/workflows/feature_dev.py
   - ~/.flowcraft/workflows/feature-dev.yaml
   - Этапы: анализ → дизайн → реализация → тесты → ревью

2. **Bug Fix Workflow**
   - src/workflows/bug_fix.py
   - ~/.flowcraft/workflows/bug-fix.yaml
   - Этапы: воспроизведение → анализ → исправление → тестирование

3. **Incident Analysis Workflow**
   - src/workflows/incident_analysis.py
   - ~/.flowcraft/workflows/incident-analysis.yaml
   - Этапы: сбор данных → анализ → план действий → исправление

4. **Software Development Workflow**
   - src/workflows/software_dev.py
   - ~/.flowcraft/workflows/software-dev.yaml
   - Этапы: планирование → архитектура → реализация → тестирование → деплой

### Результат
- Готовые workflow для основных сценариев
- YAML конфигурации
- Примеры использования

## 13. Этап 12: Тестирование и оптимизация

### Задачи
1. **Unit тесты**
   - Тесты для всех основных компонентов
   - Моки для внешних зависимостей
   - Покрытие кода > 80%

2. **Integration тесты**
   - Тесты workflow end-to-end
   - Тесты MCP интеграции
   - Тесты CLI интерфейса

3. **Оптимизация производительности**
   - Профилирование узких мест
   - Оптимизация LLM вызовов
   - Кэширование результатов

4. **Документация**
   - README с примерами использования
   - Документация API
   - Руководство пользователя

### Результат
- Протестированная система
- Оптимизированная производительность
- Полная документация

## 14. Приоритеты и зависимости

### Критический путь
1. **Базовая инфраструктура** → **Система настроек** → **Система доверия**
2. **MCP менеджер** → **Базовые инструменты** → **LLM интеграция**
3. **Менеджер агентов** → **Workflow система** → **Интерактивный CLI**
4. **Система команд** → **Конкретные workflow** → **Тестирование**

### Параллельная разработка
- **Базовые инструменты** и **LLM интеграция** можно разрабатывать параллельно
- **Менеджер агентов** и **MCP менеджер** независимы
- **Конкретные workflow** можно создавать параллельно после готовности базовой системы

### Минимально жизнеспособный продукт (MVP)
1. Базовая инфраструктура
2. Система настроек
3. Один простой workflow (bug-fix)
4. Базовый CLI интерфейс
5. Система доверия команд

## Заключение

План реализации FlowCraft выполнен в части MVP (минимально жизнеспособного продукта). Архитектура спроектирована для максимальной модульности и расширяемости, что позволит легко добавлять новые workflow и функции в будущем.

### Выполненные компоненты

- **Базовая инфраструктура** - структура проекта, зависимости, CLI
- **Система настроек** - конфигурация через YAML с валидацией
- **Система доверия команд** - безопасное выполнение системных команд
- **Базовые инструменты** - файловые операции, поиск, выполнение команд
- **Менеджер агентов** - CRUD операции с агентами
- **Базовая система workflow** - загрузка конфигураций, выполнение шагов
- **Интерактивный CLI** - простой пользовательский интерфейс

### Готовность к использованию

Текущая версия FlowCraft готова для:
- Создания и управления агентами
- Загрузки workflow из YAML конфигураций
- Базового выполнения workflow (без LLM интеграции)
- Безопасного выполнения системных команд

### Следующие шаги

Сложные компоненты перенесены в TODO.md для будущей реализации:
- MCP интеграция для расширения возможностей
- LLM провайдеры для реальной работы с AI
- LangGraph интеграция для сложных workflow
- Система команд управления во время выполнения

Ключевые преимущества подхода:
- **Инкрементальная разработка** с ранним получением результатов
- **Модульная архитектура** для легкого расширения
- **Четкие зависимости** между компонентами
- **Возможность параллельной разработки** отдельных модулей
- **Фокус на MVP** для быстрого старта проекта
